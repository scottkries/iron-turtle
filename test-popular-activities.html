<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Popular Activities</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Test Popular Activities Feature</h1>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>üî• Popular Activities (Main App)</h5>
            </div>
            <div class="card-body">
                <div id="popular-activities">
                    <p class="text-muted">Loading activities...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Actions</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="testFirebaseConnection()">Test Firebase Connection</button>
                <button class="btn btn-info ms-2" onclick="testGetPopularActivities()">Test Get Popular Activities</button>
                <button class="btn btn-success ms-2" onclick="checkActivityData()">Check Activity Data</button>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Console Output</h5>
            </div>
            <div class="card-body">
                <pre id="console-output" style="max-height: 300px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/activities.js"></script>
    
    <script>
        const output = document.getElementById('console-output');
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                logMessage += '\n' + JSON.stringify(data, null, 2);
            }
            output.textContent += logMessage + '\n\n';
            console.log(message, data);
        }
        
        async function testFirebaseConnection() {
            log('Testing Firebase connection...');
            if (window.FIREBASE_ENABLED && window.firebaseService) {
                try {
                    const testQuery = await firebaseService.db.collection('users').limit(1).get();
                    log('‚úÖ Firebase connected successfully', {
                        hasData: !testQuery.empty,
                        documentsFound: testQuery.size
                    });
                } catch (error) {
                    log('‚ùå Firebase connection error', error.message);
                }
            } else {
                log('‚ùå Firebase not enabled or service not available');
            }
        }
        
        async function testGetPopularActivities() {
            log('Testing getMostPopularActivities function...');
            if (window.firebaseService) {
                try {
                    const popularActivities = await firebaseService.getMostPopularActivities();
                    log('‚úÖ Popular activities retrieved', popularActivities);
                    
                    // Display them
                    displayPopularActivities(popularActivities);
                } catch (error) {
                    log('‚ùå Error getting popular activities', error.message);
                }
            } else {
                log('‚ùå Firebase service not available');
            }
        }
        
        async function checkActivityData() {
            log('Checking activity data in Firebase...');
            if (window.firebaseService) {
                try {
                    const snapshot = await firebaseService.db.collection('activities').limit(10).get();
                    const activities = [];
                    snapshot.forEach(doc => {
                        activities.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    log(`Found ${snapshot.size} activities (showing first 10)`, activities);
                    
                    // Count by activityId
                    const counts = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.activityId) {
                            counts[data.activityId] = (counts[data.activityId] || 0) + 1;
                        }
                    });
                    log('Activity counts by ID', counts);
                } catch (error) {
                    log('‚ùå Error checking activity data', error.message);
                }
            } else {
                log('‚ùå Firebase service not available');
            }
        }
        
        function displayPopularActivities(popularActivities) {
            const container = document.getElementById('popular-activities');
            
            if (!popularActivities || popularActivities.length === 0) {
                container.innerHTML = '<p class="text-muted">No activities yet</p>';
                return;
            }
            
            // Get activity names
            const enrichedActivities = popularActivities.map(item => {
                // Find the activity definition
                const allActivities = ActivityHelper.getAllActivities();
                const activityDef = allActivities.find(a => a.id === item.activityId);
                
                return {
                    ...item,
                    name: activityDef ? activityDef.name : item.activityId,
                    category: activityDef ? activityDef.category : 'unknown'
                };
            });
            
            // Build HTML
            let html = '<div class="list-group list-group-flush">';
            enrichedActivities.forEach((activity, index) => {
                const badgeColor = index < 3 ? 'bg-danger' : index < 6 ? 'bg-warning' : 'bg-secondary';
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <div>
                            <span>${activity.name}</span>
                        </div>
                        <span class="badge ${badgeColor} rounded-pill">${activity.count}</span>
                    </div>`;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Auto-run tests on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Page loaded, initializing tests...');
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>