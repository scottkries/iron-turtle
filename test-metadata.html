<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Metadata Collection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #output {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f5f5f5;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .metadata { color: purple; }
        .section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Test Metadata Collection</h1>
    
    <div class="section">
        <h3>Setup Test Data</h3>
        <button onclick="setupTestUsers()">1. Setup Test Users</button>
        <button onclick="addTestActivity()">2. Add Test Activity with Metadata</button>
        <button onclick="viewLatestActivity()">3. View Latest Activity</button>
    </div>
    
    <div class="section">
        <h3>Test Automatic Metadata</h3>
        <button onclick="testTimeMetadata()">Test Time Metadata</button>
        <button onclick="testDeviceMetadata()">Test Device Metadata</button>
        <button onclick="testSessionMetadata()">Test Session Metadata</button>
    </div>
    
    <div class="section">
        <h3>View All Metadata</h3>
        <button onclick="viewAllActivitiesWithMetadata()">View All Activities</button>
        <button onclick="analyzeMetadata()">Analyze Metadata Patterns</button>
        <button onclick="clearTestData()">Clear Test Data</button>
    </div>
    
    <div id="output"></div>

    <script src="js/activities.js"></script>
    <script src="js/scoring.js"></script>
    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function setupTestUsers() {
            // Create test users
            const testUsers = ['Alice', 'Bob', 'Charlie', 'Diana'];
            
            // Add some test activities for each user to create a user base
            testUsers.forEach(user => {
                const activity = {
                    id: Date.now() + Math.random() * 1000,
                    userId: user,
                    activityId: 'beer',
                    activityName: 'Beer',
                    category: 'drink',
                    basePoints: 1,
                    multipliers: [],
                    quantity: 1,
                    timestamp: Date.now() - Math.random() * 3600000, // Random time in last hour
                    points: 1
                };
                window.scoringEngine.activities.push(activity);
            });
            
            window.scoringEngine.saveActivities();
            log(`Created ${testUsers.length} test users with initial activities`, 'success');
        }
        
        function addTestActivity() {
            const testActivity = {
                id: Date.now(),
                userId: 'Alice',
                activityId: 'beer_pong',
                activityName: 'Beer Pong',
                category: 'competition',
                basePoints: 30,
                multipliers: ['deck', 'usc'],
                quantity: 1,
                competitionResult: 'win',
                timestamp: Date.now(),
                points: 120, // 30 * 2 * 2
                
                // Metadata object
                metadata: {
                    // Time metadata
                    submittedAt: new Date().toISOString(),
                    dayOfWeek: new Date().getDay(),
                    hourOfDay: new Date().getHours(),
                    timeOfDay: getTimeOfDay(),
                    
                    // Session metadata
                    sessionDuration: 3600000, // 1 hour
                    activityNumber: 5,
                    timeSinceLastActivity: 300000, // 5 minutes
                    streak: 3,
                    isFirstOfType: false,
                    
                    // Device metadata
                    deviceType: detectDeviceType(),
                    screenWidth: window.innerWidth,
                    screenHeight: window.innerHeight,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    
                    // Optional user fields
                    location: 'deck',
                    witnesses: ['Bob', 'Charlie'],
                    notes: 'Epic comeback win!',
                    hasPhoto: true,
                    
                    // Competition specific
                    opponents: ['Bob'],
                    teamMembers: ['Diana']
                }
            };
            
            window.scoringEngine.activities.push(testActivity);
            window.scoringEngine.saveActivities();
            
            log('Added test activity with full metadata:', 'success');
            log(JSON.stringify(testActivity.metadata, null, 2), 'metadata');
        }
        
        function viewLatestActivity() {
            const activities = window.scoringEngine.activities;
            if (activities.length === 0) {
                log('No activities found', 'error');
                return;
            }
            
            const latest = activities[activities.length - 1];
            log('Latest Activity:', 'info');
            log(`User: ${latest.userId}`, 'info');
            log(`Activity: ${latest.activityName}`, 'info');
            log(`Points: ${latest.points}`, 'info');
            
            if (latest.metadata) {
                log('\nMetadata:', 'metadata');
                log(JSON.stringify(latest.metadata, null, 2), 'metadata');
            } else {
                log('No metadata found', 'error');
            }
        }
        
        function testTimeMetadata() {
            const now = new Date();
            const metadata = {
                submittedAt: now.toISOString(),
                dayOfWeek: now.getDay(),
                hourOfDay: now.getHours(),
                timeOfDay: getTimeOfDay(),
                dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][now.getDay()],
                formattedTime: now.toLocaleTimeString(),
                formattedDate: now.toLocaleDateString()
            };
            
            log('Time Metadata:', 'info');
            log(JSON.stringify(metadata, null, 2), 'metadata');
        }
        
        function testDeviceMetadata() {
            const metadata = {
                deviceType: detectDeviceType(),
                screenWidth: window.innerWidth,
                screenHeight: window.innerHeight,
                pixelRatio: window.devicePixelRatio,
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
            
            log('Device Metadata:', 'info');
            log(JSON.stringify(metadata, null, 2), 'metadata');
        }
        
        function testSessionMetadata() {
            const activities = window.scoringEngine.activities.filter(a => a.userId === 'Alice');
            const metadata = {
                totalActivities: activities.length,
                sessionStart: activities.length > 0 ? new Date(Math.min(...activities.map(a => a.timestamp))) : null,
                sessionEnd: activities.length > 0 ? new Date(Math.max(...activities.map(a => a.timestamp))) : null,
                uniqueActivityTypes: [...new Set(activities.map(a => a.activityId))].length,
                totalPoints: activities.reduce((sum, a) => sum + (a.points || 0), 0)
            };
            
            log('Session Metadata for Alice:', 'info');
            log(JSON.stringify(metadata, null, 2), 'metadata');
        }
        
        function viewAllActivitiesWithMetadata() {
            const activities = window.scoringEngine.activities;
            log(`Total Activities: ${activities.length}`, 'info');
            
            activities.forEach((activity, index) => {
                log(`\n--- Activity ${index + 1} ---`, 'info');
                log(`User: ${activity.userId} | Activity: ${activity.activityName} | Points: ${activity.points}`, 'info');
                
                if (activity.metadata) {
                    log('Has Metadata: YES', 'success');
                    // Show key metadata fields
                    const meta = activity.metadata;
                    log(`  Time: ${meta.timeOfDay || 'N/A'} | Location: ${meta.location || 'N/A'} | Device: ${meta.deviceType || 'N/A'}`, 'metadata');
                    if (meta.witnesses && meta.witnesses.length > 0) {
                        log(`  Witnesses: ${meta.witnesses.join(', ')}`, 'metadata');
                    }
                    if (meta.notes) {
                        log(`  Notes: "${meta.notes}"`, 'metadata');
                    }
                } else {
                    log('Has Metadata: NO', 'error');
                }
            });
        }
        
        function analyzeMetadata() {
            const activities = window.scoringEngine.activities.filter(a => a.metadata);
            
            if (activities.length === 0) {
                log('No activities with metadata found', 'error');
                return;
            }
            
            // Analyze patterns
            const analysis = {
                totalWithMetadata: activities.length,
                timeDistribution: {},
                locationDistribution: {},
                deviceDistribution: {},
                witnessFrequency: {},
                photoCount: 0
            };
            
            activities.forEach(activity => {
                const meta = activity.metadata;
                
                // Time distribution
                if (meta.timeOfDay) {
                    analysis.timeDistribution[meta.timeOfDay] = (analysis.timeDistribution[meta.timeOfDay] || 0) + 1;
                }
                
                // Location distribution
                if (meta.location) {
                    analysis.locationDistribution[meta.location] = (analysis.locationDistribution[meta.location] || 0) + 1;
                }
                
                // Device distribution
                if (meta.deviceType) {
                    analysis.deviceDistribution[meta.deviceType] = (analysis.deviceDistribution[meta.deviceType] || 0) + 1;
                }
                
                // Witness frequency
                if (meta.witnesses) {
                    meta.witnesses.forEach(witness => {
                        analysis.witnessFrequency[witness] = (analysis.witnessFrequency[witness] || 0) + 1;
                    });
                }
                
                // Photo count
                if (meta.hasPhoto) {
                    analysis.photoCount++;
                }
            });
            
            log('Metadata Analysis:', 'info');
            log(JSON.stringify(analysis, null, 2), 'metadata');
        }
        
        function clearTestData() {
            if (confirm('Clear all test data?')) {
                localStorage.removeItem('ironTurtle_activities');
                localStorage.removeItem('ironTurtle_completedTasks');
                window.scoringEngine = new ScoringEngine();
                log('All test data cleared', 'success');
                output.innerHTML = '';
            }
        }
        
        // Helper functions
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 6) return 'late-night';
            if (hour < 12) return 'morning';
            if (hour < 17) return 'afternoon';
            if (hour < 21) return 'evening';
            return 'night';
        }
        
        function detectDeviceType() {
            const width = window.innerWidth;
            if (width < 768) return 'mobile';
            if (width < 1024) return 'tablet';
            return 'desktop';
        }
        
        // Initialize
        log('Metadata Test Page Ready', 'success');
        log('Click buttons in order to test metadata collection', 'info');
    </script>
</body>
</html>