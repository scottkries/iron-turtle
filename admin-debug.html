<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Debug - Iron Turtle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Admin Debug Page</h1>
        <p>This page checks what version of the admin.js file is loaded.</p>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>File Version Check</h5>
            </div>
            <div class="card-body">
                <div id="version-info"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Admin Dashboard Methods Check</h5>
            </div>
            <div class="card-body">
                <div id="methods-check"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Source Code Preview</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="checkAdminSource()">Check admin.js Source</button>
                <pre id="source-preview" style="max-height: 400px; overflow-y: auto; margin-top: 10px;"></pre>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- App Scripts with cache busting -->
    <script src="js/firebase-config.js?v=1.2"></script>
    <script src="js/activities.js?v=1.2"></script>
    <script src="js/scoring.js?v=1.2"></script>
    <script src="js/theme.js?v=1.2"></script>
    <script src="js/admin.js?v=1.2&debug=true"></script>
    
    <script>
        // Check what's loaded
        window.addEventListener('DOMContentLoaded', () => {
            const versionInfo = document.getElementById('version-info');
            const methodsCheck = document.getElementById('methods-check');
            
            // Check if AdminDashboard exists
            if (typeof AdminDashboard !== 'undefined') {
                versionInfo.innerHTML = '<p class="text-success">✅ AdminDashboard class is loaded</p>';
                
                // Check for specific methods
                const dashboard = new AdminDashboard();
                const methods = [
                    'deleteUser',
                    'bulkDeleteUsers',
                    'renderPopularActivities',
                    'toggleSelectAll',
                    'updateSelectionCount',
                    'filterParticipants',
                    'selectInactiveUsers',
                    'loadRecovery'
                ];
                
                let methodsHtml = '<h6>Method Availability:</h6><ul>';
                methods.forEach(method => {
                    const exists = typeof dashboard[method] === 'function';
                    const icon = exists ? '✅' : '❌';
                    const className = exists ? 'text-success' : 'text-danger';
                    methodsHtml += `<li class="${className}">${icon} ${method}: ${exists ? 'Available' : 'Missing'}</li>`;
                });
                methodsHtml += '</ul>';
                
                methodsCheck.innerHTML = methodsHtml;
                
                // Check the loadParticipants method
                if (dashboard.loadParticipants) {
                    methodsHtml += '<p class="text-info">Checking loadParticipants implementation...</p>';
                    const funcString = dashboard.loadParticipants.toString();
                    const hasDeleteButton = funcString.includes('btn-danger') && funcString.includes('deleteUser');
                    const hasBulkOps = funcString.includes('bulk-delete-btn');
                    const hasSearch = funcString.includes('participant-search');
                    
                    methodsHtml += '<h6>Feature Checks in loadParticipants:</h6><ul>';
                    methodsHtml += `<li class="${hasDeleteButton ? 'text-success' : 'text-danger'}">${hasDeleteButton ? '✅' : '❌'} Delete button in rows</li>`;
                    methodsHtml += `<li class="${hasBulkOps ? 'text-success' : 'text-danger'}">${hasBulkOps ? '✅' : '❌'} Bulk operations UI</li>`;
                    methodsHtml += `<li class="${hasSearch ? 'text-success' : 'text-danger'}">${hasSearch ? '✅' : '❌'} Search functionality</li>`;
                    methodsHtml += '</ul>';
                    
                    methodsCheck.innerHTML = methodsHtml;
                }
            } else {
                versionInfo.innerHTML = '<p class="text-danger">❌ AdminDashboard class is NOT loaded</p>';
            }
            
            // Show the script tags that are loaded
            const scripts = document.querySelectorAll('script[src*="admin.js"]');
            if (scripts.length > 0) {
                versionInfo.innerHTML += '<h6>Loaded admin.js scripts:</h6><ul>';
                scripts.forEach(script => {
                    versionInfo.innerHTML += `<li><code>${script.src}</code></li>`;
                });
                versionInfo.innerHTML += '</ul>';
            }
        });
        
        async function checkAdminSource() {
            const preview = document.getElementById('source-preview');
            try {
                const response = await fetch('js/admin.js?v=' + Date.now());
                const text = await response.text();
                
                // Check for key features in the source
                const features = {
                    'Delete button in table': text.includes('onclick="adminDashboard.deleteUser'),
                    'Bulk delete button': text.includes('bulk-delete-btn'),
                    'Search input': text.includes('participant-search'),
                    'Select all checkbox': text.includes('select-all-users'),
                    'Popular activities rendering': text.includes('renderPopularActivities'),
                    'Recovery tab': text.includes('loadRecovery')
                };
                
                let summary = 'Feature Detection in admin.js:\n';
                summary += '================================\n\n';
                
                for (const [feature, exists] of Object.entries(features)) {
                    summary += `${exists ? '✅' : '❌'} ${feature}\n`;
                }
                
                summary += '\n\nFirst 100 lines of admin.js:\n';
                summary += '================================\n\n';
                summary += text.split('\n').slice(0, 100).join('\n');
                
                preview.textContent = summary;
            } catch (error) {
                preview.textContent = 'Error fetching admin.js: ' + error.message;
            }
        }
    </script>
</body>
</html>