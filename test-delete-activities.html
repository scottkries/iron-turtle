<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Activity Deletion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Test Firebase Activity Deletion</h2>
        <p>This page tests the Firebase activity deletion functionality.</p>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Test Steps</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Enter a username and login</li>
                    <li>Create some test activities</li>
                    <li>View activities list</li>
                    <li>Test deleting individual activities</li>
                    <li>Test clearing all activities</li>
                </ol>
                
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username:</label>
                                <input type="text" class="form-control" id="username" placeholder="Enter your name">
                                <button class="btn btn-primary mt-2" onclick="login()">Login</button>
                            </div>
                            
                            <div id="logged-in-section" style="display: none;">
                                <div class="alert alert-success">
                                    Logged in as: <span id="current-user"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <h5>Quick Add Test Activities</h5>
                                    <button class="btn btn-success" onclick="addTestActivity('drink', 10)">Add Drink (+10)</button>
                                    <button class="btn btn-success" onclick="addTestActivity('food', 15)">Add Food (+15)</button>
                                    <button class="btn btn-warning" onclick="addTestActivity('penalty', -5)">Add Penalty (-5)</button>
                                </div>
                                
                                <div class="mb-3">
                                    <button class="btn btn-info" onclick="loadActivities()">üîÑ Refresh Activities</button>
                                    <button class="btn btn-danger" onclick="clearAllActivities()">üóëÔ∏è Clear All Activities</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Activities List</h5>
                            <div id="activities-list" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-muted">Login to see activities</p>
                            </div>
                            
                            <div class="mt-3">
                                <strong>Total Score: <span id="total-score" class="text-primary">0</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h5>Console Output</h5>
                    <div id="console-output" class="border rounded p-3 bg-light" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div>Console messages will appear here...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script src="js/activities.js"></script>
    <script src="js/scoring.js"></script>
    
    <script>
        let currentUser = null;
        
        // Override console.log to show in UI
        const originalLog = console.log;
        const originalError = console.error;
        
        function addToConsole(message, type = 'log') {
            const output = document.getElementById('console-output');
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-danger' : '';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            
            // Also log to real console
            if (type === 'error') {
                originalError(message);
            } else {
                originalLog(message);
            }
        }
        
        console.log = function(...args) {
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            addToConsole(args.join(' '), 'error');
        };
        
        async function login() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            try {
                if (window.firebaseService) {
                    currentUser = await window.firebaseService.signInAnonymously(username);
                    currentUser.name = username;
                    currentUser.sanitizedName = window.firebaseService.sanitizeUsername(username);
                    
                    document.getElementById('current-user').textContent = username;
                    document.getElementById('logged-in-section').style.display = 'block';
                    
                    console.log(`Logged in as: ${username}`);
                    await loadActivities();
                } else {
                    console.error('Firebase not initialized');
                    alert('Firebase is not initialized. Check the console for errors.');
                }
            } catch (error) {
                console.error('Login failed:', error.message);
                alert('Login failed: ' + error.message);
            }
        }
        
        async function addTestActivity(category, points) {
            if (!currentUser) {
                alert('Please login first');
                return;
            }
            
            try {
                const activityData = {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    userSanitizedName: currentUser.sanitizedName,
                    activityId: `test_${category}_${Date.now()}`,
                    activityName: `Test ${category} activity`,
                    category: category,
                    basePoints: points,
                    multipliers: [],
                    quantity: 1,
                    points: points,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await window.firebaseService.db.collection('activities').add(activityData);
                
                // Update user's total score
                const userRef = window.firebaseService.db.collection('users').doc(currentUser.sanitizedName);
                await userRef.update({
                    totalScore: firebase.firestore.FieldValue.increment(points),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(`Added ${category} activity with ${points} points`);
                await loadActivities();
            } catch (error) {
                console.error('Failed to add activity:', error.message);
                alert('Failed to add activity: ' + error.message);
            }
        }
        
        async function loadActivities() {
            if (!currentUser) return;
            
            try {
                const snapshot = await window.firebaseService.db.collection('activities')
                    .where('userSanitizedName', '==', currentUser.sanitizedName)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const activitiesList = document.getElementById('activities-list');
                activitiesList.innerHTML = '';
                
                if (snapshot.empty) {
                    activitiesList.innerHTML = '<p class="text-muted">No activities yet</p>';
                    document.getElementById('total-score').textContent = '0';
                    return;
                }
                
                let totalScore = 0;
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    totalScore += data.points || 0;
                    
                    const div = document.createElement('div');
                    div.className = 'mb-2 p-2 border rounded';
                    
                    const timestamp = data.timestamp ? 
                        new Date(data.timestamp.toDate()).toLocaleString() : 
                        'Just now';
                    
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${data.activityName}</strong>
                                <span class="badge bg-secondary ms-2">${data.category}</span>
                                <span class="badge ${data.points >= 0 ? 'bg-success' : 'bg-danger'} ms-1">
                                    ${data.points >= 0 ? '+' : ''}${data.points} pts
                                </span>
                                <div class="small text-muted">${timestamp}</div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteActivity('${doc.id}', ${data.points})">
                                Delete
                            </button>
                        </div>
                    `;
                    
                    activitiesList.appendChild(div);
                });
                
                document.getElementById('total-score').textContent = totalScore;
                console.log(`Loaded ${snapshot.size} activities, total score: ${totalScore}`);
                
            } catch (error) {
                console.error('Failed to load activities:', error.message);
            }
        }
        
        async function deleteActivity(docId, points) {
            if (!currentUser) return;
            
            if (confirm('Are you sure you want to delete this activity?')) {
                try {
                    // Use the Firebase service deleteActivity method
                    await window.firebaseService.deleteActivity(
                        docId, 
                        currentUser.name, 
                        points,
                        null, // activityDefId - not needed for test activities
                        false // isOneTimeTask
                    );
                    
                    console.log(`Deleted activity: ${docId}`);
                    await loadActivities();
                } catch (error) {
                    console.error('Failed to delete activity:', error.message);
                    alert('Failed to delete activity: ' + error.message);
                }
            }
        }
        
        async function clearAllActivities() {
            if (!currentUser) return;
            
            if (confirm('Are you sure you want to delete ALL activities? This cannot be undone.')) {
                if (confirm('This will permanently delete all your activities and reset your score to 0. Are you absolutely sure?')) {
                    try {
                        // Delete all activities from Firebase
                        const batch = window.firebaseService.db.batch();
                        
                        // Get all activities for this user
                        const snapshot = await window.firebaseService.db.collection('activities')
                            .where('userSanitizedName', '==', currentUser.sanitizedName)
                            .get();
                        
                        // Add each deletion to the batch
                        snapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        
                        // Execute the batch deletion
                        await batch.commit();
                        
                        // Reset user's score
                        const userRef = window.firebaseService.db.collection('users')
                            .doc(currentUser.sanitizedName);
                        await userRef.update({
                            totalScore: 0,
                            completedTasks: {}
                        });
                        
                        console.log(`Cleared all activities (${snapshot.size} total)`);
                        await loadActivities();
                    } catch (error) {
                        console.error('Failed to clear activities:', error.message);
                        alert('Failed to clear activities: ' + error.message);
                    }
                }
            }
        }
        
        // Check Firebase status on load
        window.addEventListener('load', () => {
            if (window.FIREBASE_ENABLED) {
                console.log('‚úÖ Firebase is initialized and ready');
            } else {
                console.error('‚ùå Firebase is not initialized');
            }
        });
    </script>
</body>
</html>