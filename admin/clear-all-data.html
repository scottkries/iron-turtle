<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Turtle - Clear All Data (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h2>⚠️ Clear All Database Data</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This will permanently delete ALL data from the database including:
                    <ul>
                        <li>All user accounts</li>
                        <li>All activities</li>
                        <li>All scores and achievements</li>
                        <li>All localStorage data</li>
                    </ul>
                    This action cannot be undone!
                </div>
                
                <div id="status-message"></div>
                
                <div class="d-grid gap-2 mt-4">
                    <button id="clear-firestore-btn" class="btn btn-danger btn-lg">
                        Clear Firestore Database
                    </button>
                    <button id="clear-localstorage-btn" class="btn btn-warning btn-lg">
                        Clear LocalStorage
                    </button>
                    <button id="clear-all-btn" class="btn btn-danger btn-lg">
                        Clear Everything (Firestore + LocalStorage)
                    </button>
                </div>
                
                <hr class="my-4">
                
                <h4>Database Statistics</h4>
                <div id="stats" class="mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDoHa9V7R27UUrMj2dKKACKpcO82BPuUM8",
            authDomain: "iron-turtle-tracker.firebaseapp.com",
            databaseURL: "https://iron-turtle-tracker-default-rtdb.firebaseio.com",
            projectId: "iron-turtle-tracker",
            storageBucket: "iron-turtle-tracker.firebasestorage.app",
            messagingSenderId: "923369775122",
            appId: "1:923369775122:web:71cd2023c2b92148f7f8cb"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        async function getStats() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const activitiesSnapshot = await db.collection('activities').get();
                
                const statsDiv = document.getElementById('stats');
                statsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Users</h5>
                                    <p class="card-text display-4">${usersSnapshot.size}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Activities</h5>
                                    <p class="card-text display-4">${activitiesSnapshot.size}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h5>LocalStorage Data</h5>
                        <ul>
                            <li>Username: ${localStorage.getItem('ironTurtle_username') || 'None'}</li>
                            <li>Activities: ${localStorage.getItem('ironTurtle_activities') ? JSON.parse(localStorage.getItem('ironTurtle_activities')).length : 0}</li>
                            <li>Completed Tasks: ${localStorage.getItem('ironTurtle_completedTasks') ? JSON.parse(localStorage.getItem('ironTurtle_completedTasks')).length : 0}</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                console.error('Error getting stats:', error);
                document.getElementById('stats').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading statistics: ${error.message}
                    </div>
                `;
            }
        }
        
        async function clearFirestore() {
            if (!confirm('Are you SURE you want to delete ALL Firestore data? This cannot be undone!')) {
                return;
            }
            
            showMessage('Clearing Firestore database...', 'info');
            
            try {
                // Delete all activities
                const activitiesSnapshot = await db.collection('activities').get();
                const activityDeletePromises = [];
                activitiesSnapshot.forEach((doc) => {
                    activityDeletePromises.push(doc.ref.delete());
                });
                await Promise.all(activityDeletePromises);
                console.log(`Deleted ${activitiesSnapshot.size} activities`);
                
                // Delete all users
                const usersSnapshot = await db.collection('users').get();
                const userDeletePromises = [];
                usersSnapshot.forEach((doc) => {
                    userDeletePromises.push(doc.ref.delete());
                });
                await Promise.all(userDeletePromises);
                console.log(`Deleted ${usersSnapshot.size} users`);
                
                showMessage(`Successfully deleted ${activitiesSnapshot.size} activities and ${usersSnapshot.size} users from Firestore`, 'success');
                await getStats();
            } catch (error) {
                console.error('Error clearing Firestore:', error);
                showMessage(`Error clearing Firestore: ${error.message}`, 'danger');
            }
        }
        
        function clearLocalStorage() {
            if (!confirm('Are you SURE you want to clear all LocalStorage data?')) {
                return;
            }
            
            // Clear all Iron Turtle related localStorage
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('ironTurtle')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            showMessage(`Cleared ${keysToRemove.length} localStorage items`, 'success');
            getStats();
        }
        
        async function clearEverything() {
            if (!confirm('Are you ABSOLUTELY SURE you want to delete EVERYTHING? This will clear both Firestore and LocalStorage!')) {
                return;
            }
            
            await clearFirestore();
            clearLocalStorage();
        }
        
        // Event listeners
        document.getElementById('clear-firestore-btn').addEventListener('click', clearFirestore);
        document.getElementById('clear-localstorage-btn').addEventListener('click', clearLocalStorage);
        document.getElementById('clear-all-btn').addEventListener('click', clearEverything);
        
        // Load stats on page load
        getStats();
        
        // Refresh stats every 5 seconds
        setInterval(getStats, 5000);
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>