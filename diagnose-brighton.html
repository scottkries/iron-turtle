<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Brighton Registration Diagnosis</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
    </style>
</head>
<body>
    <h1>Brighton Registration Diagnosis</h1>
    <div id="results"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        const results = document.getElementById('results');
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.textContent = msg;
            results.appendChild(div);
            console.log(msg);
        }
        
        async function diagnose() {
            try {
                // Initialize Firebase
                const firebaseConfig = {
                    apiKey: "AIzaSyDoHa9V7R27UUrMj2dKKACKpcO82BPuUM8",
                    authDomain: "iron-turtle-tracker.firebaseapp.com",
                    databaseURL: "https://iron-turtle-tracker-default-rtdb.firebaseio.com",
                    projectId: "iron-turtle-tracker",
                    storageBucket: "iron-turtle-tracker.firebasestorage.app",
                    messagingSenderId: "923369775122",
                    appId: "1:923369775122:web:71cd2023c2b92148f7f8cb"
                };
                
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                log('✓ Firebase initialized', 'success');
                
                // Test 1: Anonymous auth
                log('Testing anonymous authentication...');
                const userCred = await auth.signInAnonymously();
                log(`✓ Anonymous auth successful. UID: ${userCred.user.uid}`, 'success');
                
                // Test 2: Update profile
                log('Testing profile update with "Brighton"...');
                await userCred.user.updateProfile({ displayName: 'Brighton' });
                log('✓ Profile updated successfully', 'success');
                
                // Test 3: Sanitize username
                const sanitized = 'Brighton'.toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '')
                    .substring(0, 50);
                log(`Sanitized name: "${sanitized}"`, 'info');
                
                // Test 4: Check if user exists
                log('Checking if user document exists...');
                const userDoc = await db.collection('users').doc(sanitized).get();
                if (userDoc.exists) {
                    log(`User exists with data: ${JSON.stringify(userDoc.data())}`, 'info');
                } else {
                    log('User document does not exist yet', 'info');
                }
                
                // Test 5: Try to create/update user document
                log('Creating/updating user document...');
                try {
                    if (userDoc.exists) {
                        await db.collection('users').doc(sanitized).update({
                            currentUID: userCred.user.uid,
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        log('✓ User document updated', 'success');
                    } else {
                        await db.collection('users').doc(sanitized).set({
                            name: 'Brighton',
                            sanitizedName: sanitized,
                            currentUID: userCred.user.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            totalScore: 0,
                            completedTasks: {}
                        });
                        log('✓ User document created', 'success');
                    }
                } catch (error) {
                    log(`✗ Firestore error: ${error.message} (${error.code})`, 'error');
                    
                    // Check permissions
                    if (error.code === 'permission-denied') {
                        log('ISSUE: Firestore security rules are blocking the operation', 'error');
                        log('Solution: Check Firebase Console > Firestore > Rules', 'info');
                    }
                }
                
                // Test 6: Read back the document
                log('Reading back user document...');
                const verifyDoc = await db.collection('users').doc(sanitized).get();
                if (verifyDoc.exists) {
                    log(`✓ Document verified: ${JSON.stringify(verifyDoc.data())}`, 'success');
                } else {
                    log('✗ Could not read document', 'error');
                }
                
                log('\n=== DIAGNOSIS COMPLETE ===', 'info');
                
            } catch (error) {
                log(`CRITICAL ERROR: ${error.message}`, 'error');
                log(`Error code: ${error.code}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }
        
        // Run diagnosis
        diagnose();
    </script>
</body>
</html>